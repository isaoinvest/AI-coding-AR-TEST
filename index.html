<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AR è’¼æœˆèŠ±åœ’</title>
    
    <!-- A-Frame & MindAR -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <!-- Tailwind for UI -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      body { margin: 0; overflow: hidden; }
      
      /* æƒæä»‹é¢ */
      #scanning-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.3);
        pointer-events: none;
        transition: opacity 0.5s;
      }
      #scanning-overlay.hidden { opacity: 0; }
      
      .scanner-frame {
        width: 200px; height: 200px;
        border: 2px solid rgba(100, 200, 255, 0.5);
        border-radius: 16px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 0 15px rgba(0, 150, 255, 0.3);
      }
      
      .scanner-line {
        position: absolute;
        height: 4px; width: 100%;
        background: linear-gradient(90deg, transparent, #00ffff, transparent);
        animation: scan 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        box-shadow: 0 0 10px #00ffff;
      }
      
      @keyframes scan {
        0% { transform: translateY(-10px); }
        100% { transform: translateY(210px); }
      }

      /* UI æ§åˆ¶å±¤ (ä¸Šå‚³æŒ‰éˆ•) */
      #ui-layer {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 20;
        pointer-events: auto; /* å…è¨±é»æ“Š */
      }
      
      .hint-text {
        position: fixed;
        bottom: 30px;
        width: 100%;
        text-align: center;
        color: rgba(200, 230, 255, 0.8);
        font-size: 14px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        pointer-events: none;
        z-index: 15;
      }
    </style>
  </head>
  <body>
    
    <!-- æƒææç¤º -->
    <div id="scanning-overlay">
      <div class="scanner-frame">
        <div class="scanner-line"></div>
      </div>
      <div class="mt-4 text-cyan-200 font-bold text-shadow">è«‹æƒæç›®æ¨™åœ–åƒ</div>
    </div>

    <!-- UI æŒ‰éˆ•å€ -->
    <div id="ui-layer">
       <label class="flex items-center gap-2 bg-blue-900/80 backdrop-blur border border-blue-500 px-4 py-2 rounded-full text-white text-sm cursor-pointer shadow-lg hover:bg-blue-800 transition">
          <span>ğŸ“‚</span>
          <span>æ›´æ›èŠ±æœµè²¼åœ–</span>
          <input type="file" id="texture-upload" accept="image/*" class="hidden" />
       </label>
    </div>

    <div class="hint-text" id="hint-text">
      ç™¼ç¾ç›®æ¨™ï¼é»æ“Šè¢å¹•ç¨®æ¤èŠ±æœµ ğŸŒ±
    </div>

    <!-- AR å ´æ™¯ -->
    <a-scene
      mindar-image="imageTargetSrc: https://raw.githubusercontent.com/isaoinvest/AI-coding-AR-TEST/main/targets.mind; 
                    warmupTolerance: 5; 
                    missTolerance: 5;
                    filterMinCF: 0.0001; 
                    filterBeta: 0.001;
                    uiScanning: #scanning-overlay;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets>
        <!-- é€™è£¡ä¸éœ€è¦å½±ç‰‡è³‡æºäº† -->
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- ç›®æ¨™ 0: é€£çµåˆ°æˆ‘å€‘çš„èŠ±åœ’çµ„ä»¶ -->
      <a-entity id="target0" mindar-image-target="targetIndex: 0">
        <!-- èŠ±åœ’å¯¦é«”ï¼šåŒ…å«æ‰€æœ‰ 3D é‚è¼¯ -->
        <!-- scale è¨­ç‚º 0.5 æ˜¯ç‚ºäº†è®“ 100å–®ä½çš„èŠ±åœ’ç¸®å°æ”¾å…¥ AR ä¸–ç•Œï¼Œä½†æˆ‘å€‘æœƒèª¿æ•´å…§éƒ¨èŠ±æœµå¤§å° -->
        <a-entity flower-garden="targetIndex: 0"></a-entity>
      </a-entity>

      <!-- ç›®æ¨™ 1 (å¦‚æœéœ€è¦ä¹Ÿå¯åŠ ä¸ŠèŠ±åœ’) -->
      <a-entity id="target1" mindar-image-target="targetIndex: 1">
        <a-entity flower-garden="targetIndex: 1"></a-entity>
      </a-entity>
      
    </a-scene>

    <script>
      // --- è’¼æœˆèŠ±åœ’æ ¸å¿ƒé‚è¼¯ (ç§»æ¤è‡ª React ç‰ˆæœ¬) ---
      
      // å…¨å±€è®Šæ•¸å„²å­˜ç•¶å‰è²¼åœ–
      window.currentFlowerTexture = null;
      const DEFAULT_TEXTURE_URL = 'https://isaoinvest.com/wp-content/uploads/2025/12/Gemini_Generated_Image_5buuxi5buuxi5buu.png';

      // å®šç¾© Flower é¡åˆ¥ (ç´” JS ç‰ˆ)
      class Flower {
        constructor(x, z, texture, groupParent, sharedGeos) {
          this.x = x;
          this.z = z;
          this.age = 0;
          this.isAlive = true;
          this.speed = 1.0 + Math.random() * 0.5; // ç”Ÿé•·é€Ÿåº¦
          this.lifetime = 8 + Math.random() * 5;
          this.baseColor = new THREE.Color().setHSL(0.58 + Math.random() * 0.1, 0.8, 0.6);
          this.texture = texture;
          this.materials = [];
          this.sharedGeos = sharedGeos;
          this.parent = groupParent;
          
          this.create();
        }

        create() {
          this.group = new THREE.Group();
          this.group.position.set(this.x, 0, this.z);
          
          // --- å°ºå¯¸èª¿æ•´ï¼šè®“èŠ±æœµåœ¨ AR ä¸­çœ‹èµ·ä¾†æ›´å¤§ ---
          // åŸæœ¬æ˜¯ scale 1ï¼Œç¾åœ¨æˆ‘å€‘å°‡åŸºç¤å¤§å°æ”¾å¤§
          const BIG_SCALE = 0.3; // ç›¸å°æ–¼ç›®æ¨™å¯¬åº¦ 1ï¼Œé€™å·²ç¶“å¾ˆå¤§äº†
          this.group.scale.setScalar(BIG_SCALE); 
          
          this.group.rotation.y = Math.random() * Math.PI * 2;

          // è–
          const stemMat = new THREE.MeshStandardMaterial({ color: 0x1a332a, roughness: 0.7, transparent: true });
          this.materials.push(stemMat);
          const stem = new THREE.Mesh(this.sharedGeos.stem, stemMat);
          stem.castShadow = true;
          this.group.add(stem);

          // è‘‰
          const leafMat = new THREE.MeshStandardMaterial({ color: 0x2a4d3a, side: THREE.DoubleSide, transparent: true });
          this.materials.push(leafMat);
          for(let i=0; i<2; i++) {
              const leaf = new THREE.Mesh(this.sharedGeos.leaf, leafMat);
              leaf.position.set((i%2?-1:1)*0.15, 0.8+i*0.8, 0);
              leaf.rotation.z = (i%2?-1:1)*0.6;
              leaf.rotation.y = Math.random()*0.5;
              this.group.add(leaf);
          }

          // èŠ±ç“£
          const petalMat = new THREE.MeshStandardMaterial({ 
              color: this.texture ? 0xffffff : this.baseColor, 
              map: this.texture || null,
              side: THREE.DoubleSide, 
              transparent: true, 
              alphaTest: 0.05,
              depthWrite: false,
              emissive: this.texture ? 0x000000 : this.baseColor,
              emissiveIntensity: 0.3
          });
          this.materials.push(petalMat);
          this.petalMat = petalMat;

          for(let i=0; i<10; i++) {
              const angle = (i/10) * Math.PI * 2;
              const petal = new THREE.Mesh(this.sharedGeos.petal, petalMat);
              petal.userData = { angle, layer: i%2 };
              this.group.add(petal);
          }

          // èŠ±è•Š (ç™¼å…‰)
          const centerMat = new THREE.MeshStandardMaterial({ 
              color: 0x88ccff,
              emissive: 0x004488,
              emissiveIntensity: 1.5,
              transparent: true 
          });
          this.materials.push(centerMat);
          const center = new THREE.Mesh(this.sharedGeos.center, centerMat);
          this.group.add(center);

          this.parent.add(this.group);
        }

        update(dt, time) {
          if (!this.isAlive) return false;
          this.age += dt * this.speed;
          
          let scale = 1, h = 3, op = 1;
          
          // åŸºç¤å¤§å° (é…åˆ create ä¸­çš„æ”¾å¤§ä¿‚æ•¸)
          const BASE_SCALE = 0.3;

          if (this.age < 1.5) { 
              const t = this.age / 1.5;
              scale = t * (2-t); h = t * 3;
          } else if (this.age < this.lifetime) { 
              // é¢¨å ´æ•ˆæœ
              const windX = Math.sin(time * 1.0 + this.x * 2.0) * 0.1;
              const windZ = Math.cos(time * 0.8 + this.z * 2.0) * 0.1;
              this.group.rotation.z = windX;
              this.group.rotation.x = windZ;
              
              h = 3 + Math.sin(this.age * 2) * 0.05;
          } else { 
              const t = (this.age - this.lifetime) / 2;
              if (t >= 1) { this.isAlive = false; return false; }
              scale = 1 - t*0.2; h = 3*(1-t*0.1); op = 1-t;
              this.group.position.y = -t * 0.2; // ç·©æ…¢ä¸‹æ²‰
          }

          // æ‡‰ç”¨ç¸®æ”¾ (åŒ…å«åŸºç¤æ”¾å¤§ä¿‚æ•¸)
          this.group.scale.setScalar(scale * BASE_SCALE);
          this.materials.forEach(m => m.opacity = op);
          return true;
        }

        setTexture(tex) {
           if (this.petalMat) {
               this.petalMat.map = tex;
               this.petalMat.color.setHex(0xffffff);
               this.petalMat.emissive.setHex(0x000000);
               this.petalMat.needsUpdate = true;
           }
        }

        destroy() {
          if (this.group.parent) this.group.parent.remove(this.group);
          this.materials.forEach(m => m.dispose());
        }
      }

      // --- A-Frame è‡ªå®šç¾©çµ„ä»¶ ---
      AFRAME.registerComponent('flower-garden', {
        schema: {
          targetIndex: {type: 'int', default: 0}
        },

        init: function() {
          this.flowers = [];
          this.time = 0;
          this.isActive = false;
          
          // 1. å»ºç«‹ 3D å®¹å™¨
          this.gardenGroup = new THREE.Group();
          this.el.setObject3D('mesh', this.gardenGroup);
          
          // 2. å»ºç«‹åœ°é¢ (åŠé€æ˜æ·±è—è‰²ï¼Œåƒé­”æ³•å‚³é€é–€)
          // MindAR ç›®æ¨™é è¨­å¯¬åº¦ç‚º 1ï¼Œæˆ‘å€‘è®“åœ°é¢ç¨å¾®å¤§ä¸€é»
          const groundGeo = new THREE.PlaneGeometry(1.5, 1.5); // èª¿æ•´ç‚ºé©åˆ AR æ¯”ä¾‹
          const groundMat = new THREE.MeshStandardMaterial({
             color: 0x001133,
             transparent: true,
             opacity: 0.6,
             roughness: 0.4,
             metalness: 0.8,
             side: THREE.DoubleSide
          });
          this.ground = new THREE.Mesh(groundGeo, groundMat);
          this.ground.rotation.x = -Math.PI; // é¢å‘æ”å½±æ©Ÿ (MindAR å‚ç›´)
          this.gardenGroup.add(this.ground);
          
          // 3. ç‡ˆå…‰ (å¿…é ˆåŠ åœ¨ group å…§è·Ÿè‘—ç›®æ¨™ç§»å‹•)
          const light = new THREE.DirectionalLight(0xaaccff, 2);
          light.position.set(1, 2, 1);
          this.gardenGroup.add(light);
          
          const ambient = new THREE.AmbientLight(0x444488, 0.8);
          this.gardenGroup.add(ambient);

          // 4. é å…ˆè¼‰å…¥å¹¾ä½•é«” (æ•ˆèƒ½å„ªåŒ–)
          this.sharedGeos = {
             stem: new THREE.CylinderGeometry(0.04, 0.06, 3, 6).translate(0, 1.5, 0),
             leaf: new THREE.SphereGeometry(0.15, 6, 6).scale(2, 0.2, 1),
             petal: new THREE.PlaneGeometry(0.5, 0.8),
             center: new THREE.SphereGeometry(0.2, 10, 10)
          };

          // 5. è¼‰å…¥è²¼åœ–
          this.textureLoader = new THREE.TextureLoader();
          this.textureLoader.setCrossOrigin('anonymous');
          // å˜—è©¦è¼‰å…¥é è¨­åœ–
          this.textureLoader.load(DEFAULT_TEXTURE_URL, (tex) => {
             window.currentFlowerTexture = tex;
          });

          // 6. äº‹ä»¶ç›£è½
          this.el.sceneEl.addEventListener('click', this.handlePlanting.bind(this));
          this.el.sceneEl.addEventListener('touchstart', this.handlePlanting.bind(this));
          
          // ç›®æ¨™ç™¼ç¾/éºå¤±äº‹ä»¶
          this.el.parentEl.addEventListener('targetFound', () => {
             this.isActive = true;
             // éš±è—æƒææ¡†åœ¨ index.html çš„ CSS ä¸­è™•ç†ï¼Œé€™è£¡åªè¦ç¢ºä¿é‚è¼¯è·‘å‹•
             console.log('Target Found: Garden Active');
          });
          this.el.parentEl.addEventListener('targetLost', () => {
             this.isActive = false;
          });
        },

        handlePlanting: function(evt) {
           if (!this.isActive) return;
           
           // ç°¡å–®çš„éš¨æ©Ÿç¨®æ¤ (AR ä¸­å°„ç·šæª¢æ¸¬è¼ƒè¤‡é›œï¼Œé€™è£¡ä½¿ç”¨éš¨æ©Ÿä½ç½®ç¨®åœ¨ç›¤å­ä¸Šï¼Œé«”é©—æ›´æµæš¢)
           // ç¯„åœåœ¨ -0.5 åˆ° 0.5 ä¹‹é–“ (ç›®æ¨™å¤§å°)
           const x = (Math.random() - 0.5) * 1.0; 
           const z = (Math.random() - 0.5) * 1.0; // åœ¨ A-Frame çš„å‚ç›´é¢å…¶å¯¦æ˜¯ yï¼Œä½†æˆ‘å€‘è½‰äº† ground
           // æ³¨æ„ï¼šMindAR çš„ ImageTarget æ˜¯ Z è»¸å‘ä¸Šå—ï¼Ÿé€šå¸¸æ˜¯ XY å¹³é¢ã€‚
           
           // å»ºç«‹èŠ±æœµ
           const tex = window.currentFlowerTexture;
           const flower = new Flower(x, z, tex, this.gardenGroup, this.sharedGeos);
           // å› ç‚º ground è½‰äº† -PIï¼Œæˆ‘å€‘è¦æŠŠèŠ±ã€Œç«‹ã€åœ¨ ground ä¸Š
           // é€™è£¡éœ€è¦ä¸€é»åº§æ¨™ç³»èª¿æ•´ï¼šMindAR ç›®æ¨™å¹³é¢æ˜¯ XYï¼ŒZ æ˜¯å‚ç›´ã€‚
           // æˆ‘å€‘çš„èŠ±åŸæœ¬æ˜¯é•·åœ¨ XZ å¹³é¢ (Y å‘ä¸Š)ã€‚
           // æ‰€ä»¥æˆ‘å€‘è¦è®“èŠ±çš„ Group æ—‹è½‰ X = 90åº¦? 
           // æœ€ç°¡å–®çš„æ–¹æ³•ï¼šç›´æ¥è®“èŠ±é•·åœ¨ XY å¹³é¢ä¸Š (ä¿®æ”¹ Flower å…§éƒ¨é‚è¼¯æˆ–æ˜¯æ—‹è½‰æ•´å€‹ Container)
           
           // ä¿®æ­£ï¼šè®“èŠ±æœµå‚ç›´æ–¼å¡ç‰‡
           flower.group.rotation.x = Math.PI / 2; 
           // ä½ç½®ä¿®æ­£
           flower.group.position.set(x, y, 0); // Z=0 è²¼åœ¨åœ–ç‰‡ä¸Š
           
           // æ›´å¥½çš„åšæ³•ï¼šæˆ‘å€‘å‰›å‰›è½‰äº† Ground (rot x = 0 for AR targets usually face Z)
           // è®“æˆ‘å€‘çµ±ä¸€ï¼šGround ä¸è½‰ï¼ŒèŠ±æœµé•·åœ¨ Z è»¸ä¸Š (ç«‹èµ·ä¾†)
           
           // æœ€çµ‚ä¿®æ­£åº§æ¨™ç³»ï¼š
           flower.group.rotation.x = Math.PI / 2; // æŠŠåŸæœ¬å‘ä¸Šçš„èŠ±è½‰å‘è§€çœ¾
           flower.group.position.set(x, z, 0); // éš¨æ©Ÿåˆ†ä½ˆåœ¨ XY å¹³é¢

           this.flowers.push(flower);
           
           // æ•¸é‡é™åˆ¶
           if (this.flowers.length > 20) {
               const old = this.flowers.shift();
               old.destroy();
           }
        },

        tick: function(time, timeDelta) {
           if (!this.isActive) return;
           
           const dt = timeDelta / 1000;
           const t = time / 1000;
           
           for (let i = this.flowers.length - 1; i >= 0; i--) {
               if (!this.flowers[i].update(dt, t)) {
                   this.flowers[i].destroy();
                   this.flowers.splice(i, 1);
               }
           }
        }
      });

      // --- åœ–ç‰‡ä¸Šå‚³é‚è¼¯ ---
      const uploadInput = document.getElementById('texture-upload');
      uploadInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (event) => {
              const url = event.target.result;
              new THREE.TextureLoader().load(url, (tex) => {
                  window.currentFlowerTexture = tex;
                  
                  // æ›´æ–°ç¾æœ‰çš„èŠ±
                  // ç”±æ–¼èŠ±æœµåœ¨ A-Frame çµ„ä»¶å…§éƒ¨ï¼Œæˆ‘å€‘éœ€è¦å­˜å–çµ„ä»¶å¯¦ä¾‹ (é€™è£¡ç°¡åŒ–è™•ç†ï¼šæ–°ç¨®çš„èŠ±æœƒè®Š)
                  // æˆ–è€…æˆ‘å€‘å¯ä»¥éæ­·å ´æ™¯
                  const gardens = document.querySelectorAll('[flower-garden]');
                  gardens.forEach(el => {
                      const component = el.components['flower-garden'];
                      if (component && component.flowers) {
                          component.flowers.forEach(f => f.setTexture(tex));
                      }
                  });
              });
          };
          reader.readAsDataURL(file);
      });

      // éš±è—æƒææç¤ºé‚è¼¯
      const scene = document.querySelector('a-scene');
      const overlay = document.getElementById('scanning-overlay');
      const hint = document.getElementById('hint-text');
      
      scene.addEventListener('targetFound', () => {
         overlay.classList.add('hidden');
         hint.style.opacity = 1;
      });
      scene.addEventListener('targetLost', () => {
         // é¸æ“‡æ€§ï¼šæ˜¯å¦è¦åœ¨ä¸Ÿå¤±æ™‚é‡æ–°é¡¯ç¤ºæƒææ¡†ï¼Ÿé€šå¸¸ä¿æŒéš±è—é«”é©—è¼ƒå¥½ï¼Œæˆ–è€…å»¶é²é¡¯ç¤º
         // overlay.classList.remove('hidden'); 
         hint.style.opacity = 0.5;
      });

    </script>
  </body>
</html>
