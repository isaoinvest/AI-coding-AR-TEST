<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="preconnect" href="https://aframe.io" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        margin: 0;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
        background-color: black;
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }

      /* æƒæ UI */
      #scanning-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        background-color: rgba(0, 0, 0, 0.1);
        transition: opacity 0.3s;
        color: white;
        font-family: 'Inter', sans-serif;
        text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
      }

      #scanning-overlay.hidden {
        opacity: 0;
      }

      .scanner-frame {
        width: 180px;
        height: 180px;
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 10px;
        position: relative;
        overflow: hidden;
      }

      .scanner-line {
        position: absolute;
        height: 2px;
        width: 100%;
        background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.8), transparent);
        animation: scan 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        box-shadow: 0 0 5px rgba(0, 255, 255, 0.8);
      }

      @keyframes scan {
        0% { transform: translateY(0); }
        50% { transform: translateY(calc(180px - 2px)); }
        100% { transform: translateY(0); }
      }
      
      .scan-text {
        margin-top: 15px;
        font-size: 16px;
        color: rgba(255, 255, 255, 0.8);
      }

      /* AR è³‡è¨Šè¦†è“‹å±¤å®¹å™¨ */
      .ar-info-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        pointer-events: none;
        overflow: hidden;
      }

      /* è³‡è¨Šå¡ç‰‡ */
      .info-card {
        position: absolute;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
        backdrop-filter: blur(12px);
        border: 1.5px solid rgba(255, 255, 255, 0.3);
        border-radius: 16px;
        padding: 20px 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        max-width: 280px;
        min-width: 240px;
      }

      .info-card.active {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }

      .info-card::before {
        content: '';
        position: absolute;
        top: -1px;
        left: -1px;
        right: -1px;
        bottom: -1px;
        background: linear-gradient(45deg, 
          rgba(0, 255, 255, 0.3), 
          rgba(255, 255, 255, 0.1), 
          rgba(0, 255, 255, 0.3));
        border-radius: 16px;
        z-index: -1;
        opacity: 0;
        animation: borderGlow 3s ease-in-out infinite;
      }

      @keyframes borderGlow {
        0%, 100% { opacity: 0.2; }
        50% { opacity: 0.6; }
      }

      .info-header {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        gap: 10px;
      }

      .info-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(0, 200, 255, 0.2));
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.8; }
      }

      .info-title {
        font-size: 18px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.95);
        letter-spacing: 0.3px;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
      }

      .info-content {
        color: rgba(255, 255, 255, 0.85);
        font-size: 14px;
        line-height: 1.6;
        margin-top: 8px;
      }

      .typing-text {
        display: inline-block;
        overflow: hidden;
        white-space: nowrap;
        border-right: 2px solid rgba(0, 255, 255, 0.8);
        animation: typing 3s steps(40) 0.5s forwards, blink 0.75s step-end infinite;
        max-width: 0;
      }

      @keyframes typing {
        from { max-width: 0; }
        to { max-width: 100%; }
      }

      @keyframes blink {
        50% { border-color: transparent; }
      }

      .info-metadata {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.15);
        display: flex;
        gap: 16px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
      }

      .metadata-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .metadata-dot {
        width: 6px;
        height: 6px;
        background: rgba(0, 255, 255, 0.6);
        border-radius: 50%;
        animation: dotPulse 2s ease-in-out infinite;
      }

      @keyframes dotPulse {
        0%, 100% { opacity: 0.4; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.2); }
      }

      /* é€£æ¥ç·š */
      .connection-line {
        position: absolute;
        height: 1px;
        background: linear-gradient(90deg, 
          rgba(0, 255, 255, 0.6), 
          rgba(0, 255, 255, 0.2), 
          transparent);
        transform-origin: left center;
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      .connection-line.active {
        opacity: 1;
      }

      /* è§’è½è£é£¾ */
      .corner-decoration {
        position: absolute;
        width: 12px;
        height: 12px;
        border: 2px solid rgba(0, 255, 255, 0.5);
      }

      .corner-tl {
        top: -1px;
        left: -1px;
        border-right: none;
        border-bottom: none;
        border-top-left-radius: 16px;
      }

      .corner-tr {
        top: -1px;
        right: -1px;
        border-left: none;
        border-bottom: none;
        border-top-right-radius: 16px;
      }

      .corner-bl {
        bottom: -1px;
        left: -1px;
        border-right: none;
        border-top: none;
        border-bottom-left-radius: 16px;
      }

      .corner-br {
        bottom: -1px;
        right: -1px;
        border-left: none;
        border-top: none;
        border-bottom-right-radius: 16px;
      }
    </style>
  </head>
  <body>
    <div id="scanning-overlay">
      <div class="scanner-frame">
        <div class="scanner-line"></div>
      </div>
      <div class="scan-text">è«‹æƒæç›®æ¨™å½±åƒ</div>
    </div>

    <!-- AR è³‡è¨Šè¦†è“‹å±¤ -->
    <div class="ar-info-overlay" id="ar-overlay">
      <!-- Target 0 è³‡è¨Šå¡ç‰‡ -->
      <div class="info-card" id="info-card-0">
        <div class="corner-decoration corner-tl"></div>
        <div class="corner-decoration corner-tr"></div>
        <div class="corner-decoration corner-bl"></div>
        <div class="corner-decoration corner-br"></div>
        
        <div class="info-header">
          <div class="info-icon">ğŸ“±</div>
          <div class="info-title">äº’å‹•å½±ç‰‡é«”é©—</div>
        </div>
        <div class="info-content">
          <span class="typing-text" id="typing-text-0">é€™æ˜¯ä¸€å€‹å‰µæ–°çš„ AR äº’å‹•å½±ç‰‡å±•ç¤ºï¼Œçµåˆäº†æœ€æ–°çš„åœ–åƒè­˜åˆ¥æŠ€è¡“èˆ‡æ²‰æµ¸å¼é«”é©—è¨­è¨ˆã€‚</span>
        </div>
        <div class="info-metadata">
          <div class="metadata-item">
            <div class="metadata-dot"></div>
            <span>Target ID: 0</span>
          </div>
          <div class="metadata-item">
            <div class="metadata-dot"></div>
            <span>ç‹€æ…‹: å·²è¿½è¹¤</span>
          </div>
        </div>
      </div>

      <!-- Target 1 è³‡è¨Šå¡ç‰‡ -->
      <div class="info-card" id="info-card-1">
        <div class="corner-decoration corner-tl"></div>
        <div class="corner-decoration corner-tr"></div>
        <div class="corner-decoration corner-bl"></div>
        <div class="corner-decoration corner-br"></div>
        
        <div class="info-header">
          <div class="info-icon">ğŸ¬</div>
          <div class="info-title">é€²éšå…§å®¹å±•ç¤º</div>
        </div>
        <div class="info-content">
          <span class="typing-text" id="typing-text-1">é«”é©—æœªä¾†ç§‘æŠ€çš„è¦–è¦ºå‘ˆç¾æ–¹å¼ï¼Œé€é AR æŠ€è¡“è®“æ•¸ä½å…§å®¹èˆ‡çœŸå¯¦ä¸–ç•Œç„¡ç¸«çµåˆã€‚</span>
        </div>
        <div class="info-metadata">
          <div class="metadata-item">
            <div class="metadata-dot"></div>
            <span>Target ID: 1</span>
          </div>
          <div class="metadata-item">
            <div class="metadata-dot"></div>
            <span>ç‹€æ…‹: å·²è¿½è¹¤</span>
          </div>
        </div>
      </div>

      <!-- é€£æ¥ç·š -->
      <div class="connection-line" id="line-0"></div>
      <div class="connection-line" id="line-1"></div>
    </div>

    <a-scene
      mindar-image="imageTargetSrc: https://raw.githubusercontent.com/isaoinvest/AI-coding-AR-TEST/main/targets.mind;
                    warmupTolerance: 5;
                    missTolerance: 10;
                    filterMinCF: 0.000001; 
                    filterBeta: 250;
                    uiScanning: #scanning-overlay;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      loading-screen="enabled: true; dotsColor: #fff; backgroundColor: #000"
    >
      <a-camera
        position="0 0 0"
        look-controls="enabled: false"
      ></a-camera>

      <a-entity
        id="target0"
        mindar-image-target="targetIndex: 0"
      ></a-entity>
      
      <a-entity
        id="target1"
        mindar-image-target="targetIndex: 1"
      ></a-entity>
    </a-scene>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        if (window.AFRAME) initApp();
        else window.addEventListener('load', initApp);
      });

      function initApp() {
        const SCENE = document.querySelector("a-scene");
        const targetEl0 = document.querySelector("#target0");
        const targetEl1 = document.querySelector("#target1");
        const scanningOverlay = document.getElementById("scanning-overlay");
        const infoCard0 = document.getElementById("info-card-0");
        const infoCard1 = document.getElementById("info-card-1");
        const line0 = document.getElementById("line-0");
        const line1 = document.getElementById("line-1");
        const typingText0 = document.getElementById("typing-text-0");
        const typingText1 = document.getElementById("typing-text-1");

        let activeTargets = new Set();

        // è¨ˆç®— 2D è¢å¹•ä½ç½®
        function getScreenPosition(target) {
          const camera = SCENE.camera;
          if (!camera) return null;
          
          // ç²å–ç›®æ¨™çš„ä¸–ç•Œä½ç½®
          const targetPos = new THREE.Vector3();
          target.object3D.getWorldPosition(targetPos);
          
          // è½‰æ›åˆ°è¢å¹•åº§æ¨™
          targetPos.project(camera);

          const widthHalf = window.innerWidth / 2;
          const heightHalf = window.innerHeight / 2;

          return {
            x: (targetPos.x * widthHalf) + widthHalf,
            y: -(targetPos.y * heightHalf) + heightHalf,
            z: targetPos.z
          };
        }

        // æ›´æ–°è³‡è¨Šå¡ç‰‡ä½ç½®
        function updateInfoCardPosition(targetIndex) {
          const target = targetIndex === 0 ? targetEl0 : targetEl1;
          const card = targetIndex === 0 ? infoCard0 : infoCard1;
          const line = targetIndex === 0 ? line0 : line1;

          if (!activeTargets.has(targetIndex)) return;

          const pos = getScreenPosition(target);
          if (!pos) return;
          
          // å¦‚æœç›®æ¨™åœ¨é¡é ­å¾Œé¢ï¼Œéš±è—å¡ç‰‡
          if (pos.z > 1) {
            card.style.opacity = '0';
            line.style.opacity = '0';
            return;
          }
          
          // ç¢ºä¿å¡ç‰‡å¯è¦‹
          card.style.opacity = '1';
          line.style.opacity = '1';
          
          // æ ¹æ“šç›®æ¨™ä½ç½®èª¿æ•´å¡ç‰‡ä½ç½®
          let offsetX = 150;
          let offsetY = -100;
          
          // å‹•æ…‹èª¿æ•´åç§»é‡ï¼Œç¢ºä¿å¡ç‰‡åœ¨è¢å¹•å…§
          if (pos.x > window.innerWidth * 0.6) {
            offsetX = -150;  // é¡¯ç¤ºåœ¨å·¦é‚Š
          }
          
          if (pos.y < window.innerHeight * 0.3) {
            offsetY = 100;  // é¡¯ç¤ºåœ¨ä¸‹æ–¹
          } else if (pos.y > window.innerHeight * 0.7) {
            offsetY = -100;  // é¡¯ç¤ºåœ¨ä¸Šæ–¹
          }

          const cardX = Math.max(120, Math.min(window.innerWidth - 120, pos.x + offsetX));
          const cardY = Math.max(100, Math.min(window.innerHeight - 100, pos.y + offsetY));

          card.style.left = `${cardX}px`;
          card.style.top = `${cardY}px`;

          // æ›´æ–°é€£æ¥ç·š
          const deltaX = cardX - pos.x;
          const deltaY = cardY - pos.y;
          const lineLength = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
          const lineAngle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;

          line.style.left = `${pos.x}px`;
          line.style.top = `${pos.y}px`;
          line.style.width = `${lineLength}px`;
          line.style.transform = `rotate(${lineAngle}deg)`;
        }

        // å•Ÿå‹•ç›®æ¨™
        function activateTarget(targetIndex) {
          activeTargets.add(targetIndex);
          scanningOverlay.classList.add("hidden");

          const card = targetIndex === 0 ? infoCard0 : infoCard1;
          const line = targetIndex === 0 ? line0 : line1;
          const typingText = targetIndex === 0 ? typingText0 : typingText1;

          // é‡ç½®æ‰“å­—å‹•ç•«
          typingText.style.animation = 'none';
          setTimeout(() => {
            typingText.style.animation = '';
          }, 10);

          setTimeout(() => {
            card.classList.add("active");
            line.classList.add("active");
            updateInfoCardPosition(targetIndex);
          }, 100);
        }

        // åœç”¨ç›®æ¨™
        function deactivateTarget(targetIndex) {
          activeTargets.delete(targetIndex);

          const card = targetIndex === 0 ? infoCard0 : infoCard1;
          const line = targetIndex === 0 ? line0 : line1;

          card.classList.remove("active");
          line.classList.remove("active");

          if (activeTargets.size === 0) {
            setTimeout(() => {
              scanningOverlay.classList.remove("hidden");
            }, 300);
          }
        }

        // ç›®æ¨™è¿½è¹¤äº‹ä»¶
        targetEl0.addEventListener("targetFound", () => {
          activateTarget(0);
        });

        targetEl0.addEventListener("targetLost", () => {
          deactivateTarget(0);
        });

        targetEl1.addEventListener("targetFound", () => {
          activateTarget(1);
        });

        targetEl1.addEventListener("targetLost", () => {
          deactivateTarget(1);
        });

        // æŒçºŒæ›´æ–°ä½ç½®
        let animationFrame;
        function updateLoop() {
          if (activeTargets.size > 0) {
            activeTargets.forEach(targetIndex => {
              updateInfoCardPosition(targetIndex);
            });
          }
          animationFrame = requestAnimationFrame(updateLoop);
        }

        SCENE.addEventListener('renderstart', () => {
          updateLoop();
        });

        // æ¸…ç†
        window.addEventListener('beforeunload', () => {
          if (animationFrame) {
            cancelAnimationFrame(animationFrame);
          }
        });
      }
    </script>
  </body>
</html>
